{% extends "base.html" %}

{% block title %}Corrective Actions - {{ finding.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2">
                    <i class="fas fa-tasks me-2"></i>Corrective Actions
                </h1>
                <p class="text-muted mb-0">
                    <span class="badge bg-{{ 'danger' if finding.severity == 'critical' else 'warning' if finding.severity == 'high' else 'info' if finding.severity == 'medium' else 'success' }} me-2">
                        {{ finding.severity.title() }}
                    </span>
                    {{ finding.title }}
                </p>
            </div>
            <div class="d-flex gap-2">
                {% if user.role in ['admin', 'auditee'] or user.id == finding.assigned_to_id %}
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addActionModal">
                    <i class="fas fa-plus me-2"></i>Add Action
                </button>
                {% endif %}
                <a href="{{ url_for('audit_findings', audit_id=finding.audit.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Findings
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Finding Details Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>Finding Details</h5>
                        <p class="mb-2">{{ finding.description }}</p>
                        <small class="text-muted">
                            <strong>Category:</strong> {{ finding.category or 'Uncategorized' }} |
                            <strong>Identified by:</strong> {{ finding.identified_by.full_name if finding.identified_by else '-' }} |
                            <strong>Date:</strong> {{ finding.created_at.strftime('%m/%d/%Y') }}
                        </small>
                    </div>
                    <div class="col-md-4">
                        <div class="text-end">
                            <div class="mb-2">
                                <span class="badge bg-{{ 'success' if finding.status == 'closed' else 'warning' if finding.status == 'in_progress' else 'danger' if finding.status == 'resolved' else 'secondary' }}">
                                    {{ finding.status.replace('_', ' ').title() }}
                                </span>
                            </div>
                            <small class="text-muted">
                                <strong>Assigned to:</strong> {{ finding.assigned_to.full_name if finding.assigned_to else 'Not assigned' }}<br>
                                <strong>Due date:</strong> {{ finding.due_date.strftime('%m/%d/%Y') if finding.due_date else 'Not set' }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actions Progress Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-chart-pie me-2"></i>Actions Progress Summary
                </h6>
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-secondary">{{ actions|selectattr("status", "equalto", "planned")|list|length }}</h4>
                        <small class="text-muted">Planned</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-primary">{{ actions|selectattr("status", "equalto", "in_progress")|list|length }}</h4>
                        <small class="text-muted">In Progress</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-success">{{ actions|selectattr("status", "equalto", "completed")|list|length }}</h4>
                        <small class="text-muted">Completed</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-danger">{{ actions|selectattr("status", "equalto", "overdue")|list|length }}</h4>
                        <small class="text-muted">Overdue</small>
                    </div>
                </div>
                
                {% if actions %}
                <div class="mt-3">
                    {% set total_actions = actions|length %}
                    {% set completed_actions = actions|selectattr("status", "equalto", "completed")|list|length %}
                    {% set progress_percentage = (completed_actions / total_actions * 100)|round(1) if total_actions > 0 else 0 %}
                    <div class="d-flex justify-content-between mb-1">
                        <span>Overall Progress</span>
                        <span>{{ completed_actions }}/{{ total_actions }} ({{ progress_percentage }}%)</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: {{ progress_percentage }}%" 
                             aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Corrective Actions List -->
<div class="row">
    <div class="col-12">
        {% if actions %}
            {% for action in actions %}
            <div class="card mb-3 action-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-{{ 'success' if action.status == 'completed' else 'primary' if action.status == 'in_progress' else 'danger' if action.status == 'overdue' else 'secondary' }} me-2">
                            {{ action.status.replace('_', ' ').title() }}
                        </span>
                        <span class="badge bg-{{ 'danger' if action.priority == 'critical' else 'warning' if action.priority == 'high' else 'info' if action.priority == 'medium' else 'secondary' }} me-2">
                            {{ action.priority.title() }}
                        </span>
                        <small class="text-muted">Action #{{ loop.index }}</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        {% if action.status == 'completed' %}
                        <span class="badge bg-success">
                            <i class="fas fa-check me-1"></i>Completed {{ action.actual_completion_date.strftime('%m/%d/%Y') if action.actual_completion_date }}
                        </span>
                        {% elif action.planned_completion_date and action.planned_completion_date < today %}
                        <span class="badge bg-danger">
                            <i class="fas fa-exclamation-triangle me-1"></i>Overdue
                        </span>
                        {% endif %}
                        
                        {% if user.role in ['admin'] or user.id == action.responsible_person_id %}
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <button class="dropdown-item" onclick="updateActionProgress({{ action.id }})">
                                        <i class="fas fa-edit me-2"></i>Update Progress
                                    </button>
                                </li>
                                {% if action.status != 'completed' %}
                                <li>
                                    <button class="dropdown-item" onclick="markCompleted({{ action.id }})">
                                        <i class="fas fa-check me-2"></i>Mark Completed
                                    </button>
                                </li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <button class="dropdown-item text-danger" onclick="deleteAction({{ action.id }})">
                                        <i class="fas fa-trash me-2"></i>Delete Action
                                    </button>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ action.action_description }}</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Responsible:</strong> {{ action.responsible_person.full_name if action.responsible_person else '-' }}<br>
                                <strong>Created by:</strong> {{ action.created_by.full_name if action.created_by else '-' }}<br>
                                <strong>Created:</strong> {{ action.created_at.strftime('%m/%d/%Y') }}
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Planned completion:</strong> {{ action.planned_completion_date.strftime('%m/%d/%Y') if action.planned_completion_date else 'Not set' }}<br>
                                {% if action.actual_completion_date %}
                                <strong>Actual completion:</strong> {{ action.actual_completion_date.strftime('%m/%d/%Y') }}<br>
                                {% endif %}
                                <strong>Progress:</strong> {{ action.progress_percentage }}%
                            </small>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    {% if action.status != 'completed' %}
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Progress</small>
                            <small>{{ action.progress_percentage }}%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-{{ 'success' if action.progress_percentage >= 75 else 'warning' if action.progress_percentage >= 50 else 'info' if action.progress_percentage >= 25 else 'danger' }}" 
                                 role="progressbar" style="width: {{ action.progress_percentage }}%" 
                                 aria-valuenow="{{ action.progress_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if action.implementation_notes %}
                    <div class="mt-3">
                        <strong>Implementation Notes:</strong>
                        <p class="mb-0 mt-1">{{ action.implementation_notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Corrective Actions Yet</h5>
                    <p class="text-muted">
                        {% if user.role in ['admin', 'auditee'] or user.id == finding.assigned_to_id %}
                            Create corrective actions to address this finding.
                        {% else %}
                            No corrective actions have been created for this finding yet.
                        {% endif %}
                    </p>
                    {% if user.role in ['admin', 'auditee'] or user.id == finding.assigned_to_id %}
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addActionModal">
                        <i class="fas fa-plus me-2"></i>Add First Action
                    </button>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Action Modal -->
<div class="modal fade" id="addActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add Corrective Action
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('finding_actions', finding_id=finding.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="action_description" class="form-label">Action Description *</label>
                        <textarea class="form-control" id="action_description" name="action_description" rows="3" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="responsible_person_id" class="form-label">Responsible Person *</label>
                                <select class="form-select" id="responsible_person_id" name="responsible_person_id" required>
                                    <option value="">Select Person</option>
                                    {% for person in users %}
                                    <option value="{{ person.id }}" {% if finding.assigned_to and person.id == finding.assigned_to.id %}selected{% endif %}>
                                        {{ person.full_name }} ({{ person.role.title() }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority *</label>
                                <select class="form-select" id="priority" name="priority" required>
                                    <option value="">Select Priority</option>
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="planned_completion_date" class="form-label">Planned Completion Date *</label>
                        <input type="date" class="form-control" id="planned_completion_date" name="planned_completion_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="implementation_notes" class="form-label">Implementation Notes</label>
                        <textarea class="form-control" id="implementation_notes" name="implementation_notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Add Action
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Progress Modal -->
<div class="modal fade" id="updateProgressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Update Progress
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateProgressForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="progress_percentage" class="form-label">Progress Percentage</label>
                        <input type="range" class="form-range" id="progress_percentage" name="progress_percentage" 
                               min="0" max="100" step="5" value="0" oninput="updateProgressDisplay(this.value)">
                        <div class="d-flex justify-content-between">
                            <small>0%</small>
                            <small id="progressDisplay">0%</small>
                            <small>100%</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="status_update" class="form-label">Status Update</label>
                        <select class="form-select" id="status_update" name="status_update">
                            <option value="planned">Planned</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="progress_notes" class="form-label">Progress Notes</label>
                        <textarea class="form-control" id="progress_notes" name="progress_notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Progress
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const today = new Date();

function updateActionProgress(actionId) {
    // Show update progress modal
    const modal = new bootstrap.Modal(document.getElementById('updateProgressModal'));
    modal.show();
    
    // Set up form submission for this specific action
    document.getElementById('updateProgressForm').onsubmit = function(e) {
        e.preventDefault();
        // Implementation for updating progress
        alert('Progress update functionality would be implemented here');
        modal.hide();
    };
}

function markCompleted(actionId) {
    if (confirm('Are you sure you want to mark this action as completed?')) {
        // Implementation for marking action as completed
        alert('Mark completed functionality would be implemented here');
    }
}

function deleteAction(actionId) {
    if (confirm('Are you sure you want to delete this action? This action cannot be undone.')) {
        // Implementation for deleting action
        alert('Delete action functionality would be implemented here');
    }
}

function updateProgressDisplay(value) {
    document.getElementById('progressDisplay').textContent = value + '%';
    
    // Auto-update status based on progress
    const statusSelect = document.getElementById('status_update');
    if (value == 0) {
        statusSelect.value = 'planned';
    } else if (value == 100) {
        statusSelect.value = 'completed';
    } else {
        statusSelect.value = 'in_progress';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date to today for planned completion date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('planned_completion_date').setAttribute('min', today);
});
</script>
{% endblock %}
