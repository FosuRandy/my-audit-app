{% extends "base.html" %}

{% block title %}Head of Business Control Dashboard - Audit Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Audit Management Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar bg-light border-right">
            <div class="position-sticky pt-3">
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>Audit Management</span>
                </h6>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#overview">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('risk_assessment') }}">
                            <i class="fas fa-chart-line me-2"></i>
                            Risk Assessment
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('audit_planning') }}">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Audit Planning
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('engagement_setup') }}">
                            <i class="fas fa-cogs me-2"></i>
                            Engagement Setup
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('field_communication') }}">
                            <i class="fas fa-comments me-2"></i>
                            Fieldwork Communication
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('users') }}">
                            <i class="fas fa-users me-2"></i>
                            Manage Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('departments') }}">
                            <i class="fas fa-building me-2"></i>
                            Manage Departments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('report_library') }}">
                            <i class="fas fa-book me-2"></i>
                            Report Library
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <!-- Page Header -->
            <div class="d-sm-flex align-items-center justify-content-between mb-4 pt-3 pb-2 border-bottom">
                <h1 class="h3 mb-0 text-gray-800"><i class="fas fa-user-cog me-2"></i>Head of Business Control Dashboard</h1>
                <div class="d-none d-sm-inline-block">
                    <a href="{{ url_for('generate_report') }}" class="btn btn-sm btn-primary shadow-sm">
                        <i class="fas fa-download fa-sm text-white-50"></i> Generate Report
                    </a>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Draft Audits</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.draft_audits or 0 }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-edit fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Audits</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.active_audits or 0 }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Available Auditors</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.available_auditors or 0 }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-user-tie fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Risk Areas</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.risk_areas or 0 }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Draft Audit Plans -->
            <div class="row">
                <div class="col-xl-8 col-lg-7">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">Draft Audit Plans</h6>
                            <button type="button" class="btn btn-sm btn-danger" id="bulkDeleteBtn" onclick="bulkDeleteAudits()" style="display: none;">
                                <i class="fas fa-trash me-1"></i>Delete Selected
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th width="40">
                                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                                            </th>
                                            <th>Plan Title</th>
                                            <th>Department</th>
                                            <th>Risk Level</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if draft_audits %}
                                        {% for plan in draft_audits %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="audit-checkbox" value="{{ plan.get('id') }}" onchange="updateBulkDeleteBtn()">
                                            </td>
                                            <td>{{ plan.get('title', 'Untitled Plan') }}</td>
                                            <td>{{ plan.get('department_name', 'N/A') }}</td>
                                            <td>
                                                <span class="badge bg-{{ 'danger' if plan.get('risk_level') == 'high' else 'warning' if plan.get('risk_level') == 'medium' else 'success' }}">
                                                    {{ plan.get('risk_level', 'low').title() }}
                                                </span>
                                            </td>
                                            <td>
                                                <form method="POST" action="{{ url_for('submit_for_approval', plan_id=plan.get('id')) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Submit plan for director approval?')">Submit</button>
                                                </form>
                                                <form method="POST" action="{{ url_for('delete_audit', audit_id=plan.get('id')) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this audit plan?')">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center py-4">
                                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                                <p class="text-muted">No draft audit plans found</p>
                                                <a href="{{ url_for('audit_planning') }}" class="btn btn-primary">Create New Plan</a>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-xl-4 col-lg-5">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                <a href="{{ url_for('risk_assessment') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-chart-bar mr-3"></i> Risk Assessment
                                </a>
                                <a href="{{ url_for('audit_planning') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-calendar-alt mr-3"></i> Create Audit Plan
                                </a>
                                <a href="{{ url_for('users') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-users mr-3"></i> Manage Users
                                </a>
                                <a href="{{ url_for('departments') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-building mr-3"></i> Manage Departments
                                </a>
                                <a href="{{ url_for('assign_auditors') }}" class="list-group-item list-group-item-action">
                                    <i class="fas fa-user-tie mr-3"></i> Assign Auditors
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk Overview -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Risk Overview</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="riskChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Approved Audits Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-success">Approved Audits - Ready for Auditor Assignment</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Audit Title</th>
                                            <th>Department</th>
                                            <th>Approved Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if director_approved_audits %}
                                        {% for audit in director_approved_audits %}
                                        <tr>
                                            <td>{{ audit.get('title', 'Untitled Audit') }}</td>
                                            <td>{{ audit.get('department_name', 'N/A') }}</td>
                                            <td>{{ audit.get('approved_at', 'N/A')[:10] if audit.get('approved_at') else 'N/A' }}</td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#assignAuditorModal{{ audit.get('id') }}">
                                                    <i class="fas fa-user-tie me-1"></i>Assign Auditor
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center py-4">
                                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                                <p class="text-muted">No approved audits pending assignment</p>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignment Modals -->
            {% for audit in director_approved_audits %}
            <div class="modal fade" id="assignAuditorModal{{ audit.get('id') }}" tabindex="-1" aria-labelledby="assignAuditorModalLabel{{ audit.get('id') }}" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="assignAuditorModalLabel{{ audit.get('id') }}">
                                <i class="fas fa-user-tie me-2"></i>Assign Auditor to: {{ audit.get('title', 'Untitled Audit') }}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="POST" action="{{ url_for('assign_auditor', audit_id=audit.get('id')) }}">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="auditor{{ audit.get('id') }}" class="form-label">Select Auditor *</label>
                                    <select class="form-select" id="auditor{{ audit.get('id') }}" name="auditor_id" required>
                                        <option value="">-- Choose an Auditor --</option>
                                        {% for auditor in auditors %}
                                        <option value="{{ auditor.get('id') }}">
                                            {{ auditor.get('first_name', '') }} {{ auditor.get('last_name', '') }} 
                                            ({{ auditor.get('department_name', 'N/A') }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="auditee{{ audit.get('id') }}" class="form-label">Select Auditee (Optional)</label>
                                    <select class="form-select" id="auditee{{ audit.get('id') }}" name="auditee_id">
                                        <option value="">-- Choose an Auditee --</option>
                                        {% for auditee in auditees %}
                                        <option value="{{ auditee.get('id') }}">
                                            {{ auditee.get('first_name', '') }} {{ auditee.get('last_name', '') }}
                                            ({{ auditee.get('department_name', 'N/A') }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> The auditor will be notified and asked to acknowledge the assignment.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check me-2"></i>Assign Auditor
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Auditor Assignment -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Available Auditors</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Auditor Name</th>
                                            <th>Department</th>
                                            <th>Specialization</th>
                                            <th>Current Load</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if available_auditors %}
                                        {% for auditor in available_auditors %}
                                        <tr>
                                            <td>{{ auditor.get('first_name', '') + ' ' + auditor.get('last_name', '') }}</td>
                                            <td>{{ auditor.get('department_name', 'N/A') }}</td>
                                            <td>{{ auditor.get('specialization', 'General') }}</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-{{ 'danger' if auditor.get('workload', 0) > 80 else 'warning' if auditor.get('workload', 0) > 60 else 'success' }}" 
                                                         role="progressbar" style="width: {{ auditor.get('workload', 0) }}%;">
                                                        {{ auditor.get('workload', 0) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if auditor.get('status') == 'available' else 'warning' if auditor.get('status') == 'busy' else 'danger' }}">
                                                    {{ auditor.get('status', 'available').title() }}
                                                </span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignAuditorModal{{ auditor.get('id') }}">
                                                    Assign
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center py-4">
                                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                                <p class="text-muted">No auditors available</p>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Risk Chart
if (document.getElementById('riskChart')) {
    const ctx = document.getElementById('riskChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['High Risk', 'Medium Risk', 'Low Risk'],
            datasets: [{
                data: [{{ stats.high_risk or 3 }}, {{ stats.medium_risk or 8 }}, {{ stats.low_risk or 15 }}],
                backgroundColor: ['#e74c3c', '#f39c12', '#2ecc71'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Bulk delete functions
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.audit-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkDeleteBtn();
}

function updateBulkDeleteBtn() {
    const checkedBoxes = document.querySelectorAll('.audit-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    if (checkedBoxes.length > 0) {
        bulkDeleteBtn.style.display = 'inline-block';
    } else {
        bulkDeleteBtn.style.display = 'none';
    }
}

function bulkDeleteAudits() {
    const checkedBoxes = document.querySelectorAll('.audit-checkbox:checked');
    const auditIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (auditIds.length === 0) {
        alert('Please select at least one audit to delete');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${auditIds.length} audit plan(s)?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("bulk_delete_audits") }}';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'audit_ids';
        input.value = JSON.stringify(auditIds);
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}