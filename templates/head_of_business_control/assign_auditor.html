{% extends "base.html" %}

{% block title %}Assign Auditor - {{ audit.get('title', 'Untitled Audit') }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                <i class="fas fa-user-plus me-2"></i>Assign Auditor
            </h1>
            <div>
                <span class="badge bg-primary fs-6">{{ audit.get('id', 'N/A')[:8] }}</span>
                <span class="badge bg-success ms-2">Director Approved</span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Audit Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clipboard-check me-2"></i>Audit Details
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Title:</strong> {{ audit.get('title', 'Untitled') }}</p>
                        <p><strong>Type:</strong> {{ audit.get('audit_type', 'N/A').replace('_', ' ').title() }}</p>
                        <p><strong>Risk Level:</strong> 
                            <span class="badge bg-{{ 'danger' if audit.get('risk_level') == 'high' else 'warning' if audit.get('risk_level') == 'medium' else 'success' }}">
                                {{ audit.get('risk_level', 'low').title() }}
                            </span>
                        </p>
                        <p><strong>Department:</strong> {{ audit.get('department_name', 'Not specified') }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Planned Start:</strong> {{ audit.get('planned_start_date', 'Not set') }}</p>
                        <p><strong>Planned End:</strong> {{ audit.get('planned_end_date', 'Not set') }}</p>
                        <p><strong>Director Approved:</strong> {{ audit.get('approved_at', 'N/A')[:10] if audit.get('approved_at') else 'Not approved' }}</p>
                    </div>
                </div>
                
                {% if audit.get('description') %}
                <div class="mt-3">
                    <strong>Description:</strong>
                    <p class="text-muted">{{ audit.get('description') }}</p>
                </div>
                {% endif %}
                
                {% if audit.get('director_feedback') %}
                <div class="mt-3">
                    <strong>Director Feedback:</strong>
                    <div class="bg-light p-3 rounded">
                        <p class="mb-0 text-success">{{ audit.get('director_feedback') }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Auditor Assignment Form -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user-plus me-2"></i>Select Auditor
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="auditor_id" class="form-label">Choose Lead Auditor <span class="text-danger">*</span></label>
                        <select class="form-select" id="auditor_id" name="auditor_id" required>
                            <option value="">Select an auditor...</option>
                            {% for auditor in available_auditors %}
                            <option value="{{ auditor.get('id') }}">
                                {{ auditor.get('first_name', '') }} {{ auditor.get('last_name', '') }} - {{ auditor.get('department_name', 'No Department') }}
                                {% if auditor.get('email') %} ({{ auditor.get('email') }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Select the auditor who will lead this audit</div>
                    </div>

                    <div class="mb-3">
                        <label for="assignment_notes" class="form-label">Assignment Notes <small class="text-muted">(Optional)</small></label>
                        <textarea class="form-control" id="assignment_notes" name="assignment_notes" rows="4"
                                  placeholder="Provide any specific instructions, priorities, or notes for the assigned auditor..."></textarea>
                        <div class="form-text">These notes will be included in the assignment notification to the auditor</div>
                    </div>
                    
                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-user-check me-2"></i>Assign Auditor
                        </button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Available Auditors Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>Available Auditors ({{ available_auditors|length }})
                </h5>
            </div>
            <div class="card-body">
                {% if available_auditors %}
                {% for auditor in available_auditors %}
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <div>
                        <strong>{{ auditor.get('first_name', '') }} {{ auditor.get('last_name', '') }}</strong><br>
                        <small class="text-muted">{{ auditor.get('department_name', 'No Department') }}</small>
                    </div>
                    <div>
                        <span class="badge bg-success">Active</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                    <h5>No Auditors Available</h5>
                    <p class="text-muted">No active auditors found in the system.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Workflow Status -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-project-diagram me-2"></i>Workflow Status
                </h5>
            </div>
            <div class="card-body">
                <div class="workflow-steps">
                    <div class="workflow-step completed">
                        <div class="step-icon bg-success">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-content">
                            <strong>Plan Created</strong>
                            <div class="small text-muted">by Head of Business Control</div>
                        </div>
                    </div>
                    
                    <div class="workflow-step completed">
                        <div class="step-icon bg-success">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-content">
                            <strong>Director Approved</strong>
                            <div class="small text-muted">{{ audit.get('approved_at', 'N/A')[:10] if audit.get('approved_at') else 'N/A' }}</div>
                        </div>
                    </div>
                    
                    <div class="workflow-step active">
                        <div class="step-icon bg-warning">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="step-content">
                            <strong>Auditor Assignment</strong>
                            <div class="small text-muted">Current Step</div>
                        </div>
                    </div>
                    
                    <div class="workflow-step">
                        <div class="step-icon bg-secondary">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-content">
                            <strong>Audit Execution</strong>
                            <div class="small text-muted">Next Step</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.workflow-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.workflow-step {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.step-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.875rem;
}

.workflow-step.completed .step-icon {
    background-color: #28a745 !important;
}

.workflow-step.active .step-icon {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.step-content strong {
    font-size: 0.9rem;
}
</style>
{% endblock %}